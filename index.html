<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>VEQM by funpopgen</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">VEQM</h1>
        <p class="header">VEQM: Variance association mapping for molecular phenotypes</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/funpopgen/veqm/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/funpopgen/veqm/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/funpopgen/veqm">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/funpopgen">funpopgen</a></p>


      </header>
      <section>
        <h1>
<a id="veqm" class="anchor" href="#veqm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>VEQM</h1>

<p>Genetic loci which are associated with the variance, rather than the mean, of a trait are known as v-eQTL. These can indicate the presence of genetic interactions, gene-environment interactions, parent of origin effects, linkage with mean effect variants, or canalisation. This package provides a tool for discovering these loci affecting molecular phenotypes.</p>

<hr>

<h2>
<a id="contents" class="anchor" href="#contents" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Contents</h2>

<ol>
<li><a href="#downloading-veqm">Downloading VEQM</a></li>
<li><a href="#input-data-formats">Input data formats</a></li>
<li><a href="#mapping-v-eqtl">Mapping v-eQTL</a></li>
<li><a href="#mapping-variance-effects-related-to-parent-of-origin-eqtl">Mapping variance effects related to parent of origin eQTL</a></li>
<li><a href="#processing-results">Processing results</a></li>
<li><a href="#building-from-source">Building from source</a></li>
</ol>

<hr>

<h2>
<a id="downloading-veqm" class="anchor" href="#downloading-veqm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Downloading VEQM</h2>

<p>VEQM binaries can be downloaded from here:</p>

<p><a href="https://github.com/funpopgen/VEQM/releases/tag/v1.0">https://github.com/funpopgen/VEQM/releases/tag/v1.0</a></p>

<p>The standard binary is called VEQM. Use VEQM_CentOS if there is an error referring to GLIBC.</p>

<p>If there are any issues, you can try <a href="#building-from-source">building from source</a>, or contact <a href="mailto:andrew.brown@unige.ch">andrew.brown@unige.ch</a>.</p>

<p>VEQM requires tabix to be installed, tabix can be found here: <a href="https://github.com/samtools/htslib">https://github.com/samtools/htslib</a>.</p>

<hr>

<h2>
<a id="input-data-formats" class="anchor" href="#input-data-formats" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Input data formats</h2>

<p>VEQM uses the same data formats as fastQTL (<a href="http://fastqtl.sourceforge.net/">http://fastqtl.sourceforge.net/</a>), with the exception that the bed file should be uncompressed. To convert the fastQTL bed file run the following line:</p>

<pre><code>gunzip myphenotypefile.bed.gz
</code></pre>

<hr>

<h2>
<a id="mapping-v-eqtl" class="anchor" href="#mapping-v-eqtl" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Mapping v-eQTL</h2>

<p>v-eQTL, SNPs associated with the variance of gene expression, can be caused by epistasis, gene-environment interactions, and partial linkage with eQTL (<a href="https://elifesciences.org/content/3/e01381">Brown et al., 2014</a>).</p>

<p>To run VEQM, all that is necessary is a bed file containing expression values (expression.bed) and a vcf file containing genotype values (genotype.vcf.gz, either the DS or GT field must be present).</p>

<p>VEQM has been designed so that the full analysis can be broken up into chunks, which can be submitted as cluster jobs separately. This requires two flags (if neither are present the whole analysis will be submitted), --genes specifies the number of genes to be analysed in each job, --job-number indexes the job. Therefore, if --genes 10 is specified, --job-number 1 will analyse genes 1-10 in the bed file, --job-number 2 will process genes 11-20 and so on.</p>

<p>To submit a job array, with a bed file of 9,995 genes, where each job analyses 50 genes (9,995 / 50 = 199.9, so we need to run 200 jobs to cover all genes), we would submit the following command to an LSF cluster:</p>

<pre><code> bsub -o out -J"VEQM[1-200]" \
     "VEQM --bed expression.bed --vcf genotype.vcf.gz --genes 50 \
     --job-number \$LSB_JOBINDEX --out results\$LSB_JOBINDEX"
</code></pre>

<p>In addition, the --perm option allows you to set the number of permutations used in the analysis, and optionally a seed.</p>

<p>Each results file should look like this:</p>

<p><img src="screenshots/VEQM.results.png" alt="VEQM results example"></p>

<p>The first 5 columns indicate the gene and SNP (specified by chromosome, location, and reference and alternate alleles), then we report the Spearman correlation between the "distance" measure and genotype (positive indicates increased variance with the alternate allele), P value, permutation P value (not controlled for multiple testing), permutation P value controlled for multiple testing across the SNPs, and the beta approximation adjusted P value.</p>

<h2>
<a id="mapping-variance-effects-related-to-parent-of-origin-eqtl" class="anchor" href="#mapping-variance-effects-related-to-parent-of-origin-eqtl" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Mapping variance effects related to parent of origin eQTL</h2>

<p>Parent of origin eQTL occur when the effect of a genetic variant on expression depends on whether the variant is inherited from the mother or the father. Such effects can be observed as an increase in variance in the heterozygote group (<a href="http://journals.plos.org/plosgenetics/article?id=10.1371/journal.pgen.1004508">Hoggart et al., 2014</a>). It is recommended that the genotype file only contain variants with reasonable numbers of minor allele homozygotes and heterozygotes if this analysis is run (we recommend more than 50 in both categories), as otherwise standard v-eQTL could mistakenly be discovered. The command to run this analysis is the same as the standard analysis, with the addition of the flag <strong>--het</strong>:</p>

<pre><code> bsub -o out -J"VEQM[1-200]" \
     "VEQM --bed expression.bed --vcf genotype.vcf.gz --genes 50 \
     --job-number \$LSB_JOBINDEX --het --out results\$LSB_JOBINDEX"
</code></pre>

<h2>
<a id="processing-results" class="anchor" href="#processing-results" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Processing results</h2>

<p>Running the commands described above will produce 200 results files, results1-results200. To concatenate them together run:</p>

<pre><code> awk 'FNR&gt;1||NR==1' results* &gt; results.all
</code></pre>

<p>To extract the most significant association for each gene, run the following command:</p>

<pre><code>cat &lt;(head -1 results.all) &lt;(tail -n+2 results.all |  \
    awk '{if (best[$1]=="" || p_best[$1] &gt; $7) {best[$1] = $0; p_best[$1]=$7}} \
    END{for (var in best) print best[var]}') &gt; results.best
</code></pre>

<p>The results are corrected for multiple testing across the SNPs. To correct for multiple testing across the genes as well, we can use the <a href="http://genomine.org/papers/Storey_FDR_2011.pdf">qvalue package</a> in R.</p>

<p>Within R, load the data with the following command:</p>

<pre><code>results &lt;- read.table(file = "results.best", header = T)
</code></pre>

<p>A new object with adjusted P values can then be calculated:</p>

<pre><code>library(qvalue)
results &lt;- data.frame(results, Qvalues = qvalue(results$BETA)$qvalues)
</code></pre>

<p>To write out this table, run:</p>

<pre><code>write.table(results, file = "results.adjusted", col.names = T, row.names = F, sep = '\t', quote = F)
</code></pre>

<p>The final column in results.adjusted now contains Q values, which sets a threshold for estimating the false discovery rate while accounting for all SNPs and genes tested.</p>

<hr>

<h2>
<a id="building-from-source" class="anchor" href="#building-from-source" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Building from source</h2>

<p>This requires a D compiler and a version of the GNU scientific library to be installed. Running the command:</p>

<pre><code>gsl-config --version
</code></pre>

<p>should report the gsl version. If this fails, please follow the instructions <a href="https://www.gnu.org/software/gsl/">here</a> to install the library, or contact your system administrator.</p>

<h3>
<a id="cloning-the-repository" class="anchor" href="#cloning-the-repository" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Cloning the repository</h3>

<p>First, clone the repository by running:</p>

<pre><code>git clone https://github.com/funpopgen/veqm.git
</code></pre>

<p>This should create a folder called veqm. Inside this folder is a file called makefile, in the first two lines we can specify the location of the D compiler.</p>

<h3>
<a id="download-a-d-compiler" class="anchor" href="#download-a-d-compiler" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Download a D compiler</h3>

<p>Then, download a D compiler from either here: <a href="https://github.com/ldc-developers/ldc/releases">https://github.com/ldc-developers/ldc/releases</a> or here: <a href="http://dlang.org/dmd-linux.html">http://dlang.org/dmd-linux.html</a> (ldc produces faster software, my experience is that dmd works better on older operating systems). Decompress the downloaded file, then edit either the first or second line of the makefile in the VEQM folder so that it contains the full path to the relevant compiler, i.e. either:</p>

<p><strong>DMD = /path/to/dmd2/linux/bin64/dmd</strong></p>

<p>or</p>

<p><strong>LDC = /path/to/ldc2-1.1.0-beta2-linux-x86_64/bin/ldc2</strong></p>

<h3>
<a id="building-the-software" class="anchor" href="#building-the-software" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Building the software</h3>

<p>Now to compile, if you downloaded the ldc compiler, run the following command:</p>

<pre><code>make test &amp;&amp; make
</code></pre>

<p>For dmd run:</p>

<pre><code>make dmd_test &amp;&amp; make dmd
</code></pre>

<p>Now the VEQM binary should be within the bin folder in the VEQM directory, running</p>

<pre><code> ./bin/VEQM --help
</code></pre>

<p>should bring up the help.</p>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
